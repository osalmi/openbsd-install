#!/bin/sh

myusage() {
    echo "Usage: `basename $0` <target>"
    echo "  src         - checkout or update sources"
    echo "  kernel      - build and install kernel"
    echo "  system      - build and install system"
    echo "  release     - build release files"
    exit 1
}

mysrc() {
    SERVER="anoncvs@anoncvs.eu.openbsd.org:/cvs"
    BRANCH="OPENBSD_`uname -r | sed 's/\./_/'`"

    cd /usr || exit 1
    if [ -d src/CVS ]; then
        cd src && cvs -q up -r $BRANCH -Pd
    else
        cvs -qd $SERVER get -r $BRANCH -P src
    fi
}

mykernel() {
    if [ $(sysctl -n hw.ncpufound) -gt 1 ]; then
        BOOT=GENERIC.MP
    else
        BOOT=GENERIC
    fi
    for kernel in GENERIC GENERIC.MP; do
        cd /usr/src/sys/arch/${MYARCH}/conf
        config ${kernel}
        cd /usr/src/sys/arch/${MYARCH}/compile/${kernel}
        make clean depend all
        test ${kernel} = ${BOOT} && make install
    done
}

mysystem() {
    cd /usr/obj && rm -fr *
    cd /usr/src && make obj
    cd /usr/src/etc && env DESTDIR=/ make distrib-dirs
    cd /usr/src && make build
}

myrelease() {
    MYDATE=`date +%Y%m%d`
    export DESTDIR="/var/tmp/build-dest-${MYDATE}/${MYARCH}"
    export RELEASEDIR="/var/tmp/build-release-${MYDATE}/${MYARCH}"

    [ -d "${DESTDIR}" ] && rm -fr ${DESTDIR}
    [ -d "${RELEASEDIR}" ] && rm -fr ${RELEASEDIR}
    mkdir -p ${DESTDIR} ${RELEASEDIR}
    cd /usr/src/distrib/special/libstubs && make obj depend all install
    cd /usr/src/etc && make release
    cd /usr/src/distrib/sets && sh checkflist
}

MYARCH=`uname -m`

umask 022

case $1 in
    src)
    mysrc
    ;;

    kernel)
    mykernel
    ;;

    system)
    mysystem
    ;;

    release)
    myrelease
    ;;

    *)
    myusage
    ;;
esac
